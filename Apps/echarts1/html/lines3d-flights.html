<!DOCTYPE html>
<html style="height: 100%">
<head>
    <meta charset="utf-8">
</head>
<body style="height: 100%; margin: 0">
<div id="container" style="height: 100%"></div>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/echarts.min.js"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts-gl/echarts-gl.min.js"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts-stat/ecStat.min.js"></script>
<script type="text/javascript"
        src="http://echarts.baidu.com/gallery/vendors/echarts/extension/dataTool.min.js"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/map/js/china.js"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/map/js/world.js"></script>
<script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=ZUONbpqGBsYGXNIYHicvbAbM"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/extension/bmap.min.js"></script>
<script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/simplex.js"></script>
<script src="http://libs.baidu.com/jquery/2.1.4/jquery.min.js"></script>
<script type="text/javascript">
    var dom = document.getElementById("container");
    var myChart = echarts.init(dom);
    var app = {};
    option = null;
    var pic = "../data-gl/asset/world.200409.3x5400x2700.jpg";
    var d;

    $.getJSON('./flights.json', function (data) {
        d = data;
        var airports = data.airports.map(function (item) {
            return {
                coord: [item[3], item[4]]
            }
        });

        function getAirportCoord(idx) {
            return [data.airports[idx][3], data.airports[idx][4]];
        }

        // Route: [airlineIndex, sourceAirportIndex, destinationAirportIndex]
        var routesGroupByAirline = {};
        data.routes.forEach(function (route) {
            var airline = data.airlines[route[0]];
            var airlineName = airline[0];
            if (!routesGroupByAirline[airlineName]) {
                routesGroupByAirline[airlineName] = [];
            }
            routesGroupByAirline[airlineName].push(route);
        });

        var pointsData = [];
        data.routes.forEach(function (airline) {
            pointsData.push(getAirportCoord(airline[1]));
            pointsData.push(getAirportCoord(airline[2]));
        });

        var series = data.airlines.map(function (airline) {
            var airlineName = airline[0];
            var routes = routesGroupByAirline[airlineName];

            if (!routes) {
                return null;
            }
            return {
                type: 'lines3D',
                name: airlineName,
                effect: {
                    show: true,
                    trailWidth: 2,
                    trailLength: 0.15,
                    trailOpacity: 1,
                    trailColor: 'rgb(30, 30, 60)'
                },

                lineStyle: {
                    width: 2,
                    color: 'rgb(50, 50, 150)',
                    // color: 'rgb(118, 233, 241)',
                    opacity: 0.5
                },
                blendMode: 'lighter',

                data: routes.map(function (item) {
                    return [airports[item[1]].coord, airports[item[2]].coord];
                })
            };
        }).filter(function (series) {
            return !!series;
        });
        series.push({
            type: 'scatter3D',
            coordinateSystem: 'globe',
            blendMode: 'lighter',
            symbolSize: 2,
            itemStyle: {
                color: 'rgb(50, 50, 150)',
                opacity: 0.5
            },
            data: pointsData
        });


        // var airlines = data.airlines[data.routes[0]];
        // var url = series[2];
        option = {
            baseOption: {
                legend: {
                    selectedMode: 'single',
                    left: 'left',
                    data: Object.keys(routesGroupByAirline),
                    orient: 'vertical',
                    textStyle: {
                        color: '#fff'
                    }
                },
                // timeline: {
                //     axisType: 'category',
                //     orient: 'vertical',
                //     autoPlay: true,
                //     inverse: true,
                //     playInterval: 1000,
                //     left: null,
                //     right: 0,
                //     top: 20,
                //     bottom: 20,
                //     width: 55,
                //     height: null,
                //     label: {
                //         normal: {
                //             textStyle: {
                //                 color: '#999'
                //             }
                //         },
                //         emphasis: {
                //             textStyle: {
                //                 color: '#fff'
                //             }
                //         }
                //     },
                //     symbol: 'none',
                //     lineStyle: {
                //         color: '#555'
                //     },
                //     checkpointStyle: {
                //         color: '#bbb',
                //         borderColor: '#777',
                //         borderWidth: 2
                //     },
                //     controlStyle: {
                //         showNextBtn: false,
                //         showPrevBtn: false,
                //         normal: {
                //             color: '#666',
                //             borderColor: '#666'
                //         },
                //         emphasis: {
                //             color: '#aaa',
                //             borderColor: '#aaa'
                //         }
                //     },
                //     data: []
                // },
                globe: {
                    baseTexture: pic,
                    heightTexture: pic,
                    displacementScale: 0.04,
                    shading: 'realistic',
                    environment: '../data-gl/asset/starfield.jpg',
                    realisticMaterial: {
                        roughness: 0.9
                    },
                    postEffect: {
                        enable: true,
                        bloom: {
                            enable: true,
                            bloomIntensity: 0.5
                        }
                    },
                    light: {
                        main: {
                            intensity: 5,
                            shadow: true
                        },
                        ambientCubemap: {
                            texture: '../data-gl/asset/pisa.hdr',
                            diffuseIntensity: 0.2
                        }
                    }
                },
                series: series
            },
            options: []
        };

        window.addEventListener('keydown', function () {
            series.forEach(function (series, idx) {
                myChart.dispatchAction({
                    type: 'lines3DToggleEffect',
                    seriesIndex: idx
                });
            })
        });


        myChart.setOption(option);

        // var n = 2;
        // setInterval(function () {
        //     n = n % 2;
        //     pic = d.pic[n];
        //     myChart.setOption(option.globe, true);
        //     n = n + 1;
        // }, 10000)
    });


    if (option && typeof option === "object") {
        myChart.setOption(option, true);
    }


</script>
</body>
</html>